<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RDS Admin - Manage Library</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* Admin Specific Custom CSS */
        body { background-color: #f4f6f9; }
        
        .admin-header {
            background: #2c3e50;
            color: white;
            padding: 1rem 0;
            margin-bottom: 2rem;
        }

        .admin-tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .tab-btn {
            padding: 10px 25px;
            border: none;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: 0.3s;
        }

        .tab-btn.active {
            background: #3498db;
            color: white;
        }

        .admin-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            display: none; /* Hidden by default */
        }

        .admin-card.active-section {
            display: block; /* Show when active */
        }

        /* Form Styles */
        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: 'Poppins', sans-serif;
        }
        
        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .data-table th, .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .data-table th { background-color: #f8f9fa; color: #333; }
        
        .action-btn {
            padding: 6px 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            color: white;
            font-size: 14px;
        }
        .btn-delete { background-color: #e74c3c; }
        .btn-view { background-color: #3498db; margin-right: 5px; }

        /* Stats in Admin */
        .admin-stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .stat-box h2 { color: #3498db; font-size: 2.5rem; margin: 10px 0; }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #2ecc71;
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            display: none;
            animation: slideIn 0.5s ease-in-out;
            z-index: 1000;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
    </style>
</head>
<body>

    <header class="admin-header">
        <div class="container">
            <div class="header-content" style="justify-content: space-between;">
                <div class="logo">
                    <i class="fas fa-user-shield"></i>
                    <h1>RDS Admin Panel</h1>
                </div>
                <a href="index.html" class="btn btn-primary" target="_blank">
                    <i class="fas fa-external-link-alt"></i> Visit Live Site
                </a>
            </div>
        </div>
    </header>

    <div class="container">
        
        <div class="admin-stats-row">
            <div class="stat-box">
                <i class="fas fa-file-pdf fa-2x" style="color: #e74c3c;"></i>
                <h2 id="adminTotalPdfs">0</h2>
                <p>Total Documents</p>
            </div>
            <div class="stat-box">
                <i class="fas fa-folder fa-2x" style="color: #f39c12;"></i>
                <h2 id="adminTotalCats">0</h2>
                <p>Categories</p>
            </div>
            <div class="stat-box">
                <i class="fas fa-download fa-2x" style="color: #27ae60;"></i>
                <h2 id="adminTotalDownloads">0</h2>
                <p>Total Downloads</p>
            </div>
        </div>

        <div class="admin-tabs">
            <button class="tab-btn active" onclick="switchTab('upload')">
                <i class="fas fa-plus-circle"></i> Add New PDF
            </button>
            <button class="tab-btn" onclick="switchTab('manage')">
                <i class="fas fa-list"></i> Manage Files
            </button>
        </div>

        <div id="upload" class="admin-card active-section">
            <h3 style="margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px;">
                Upload New Document
            </h3>
            <form id="addPdfForm">
                <div class="form-group">
                    <label class="form-label">PDF Title / Name</label>
                    <input type="text" id="pdfTitle" class="form-control" placeholder="Ex: Physics Chapter 1 Note" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Category (Type new or select existing)</label>
                    <input type="text" id="pdfCategory" class="form-control" list="categoryList" placeholder="Ex: Physics" required autocomplete="off">
                    <datalist id="categoryList">
                        </datalist>
                </div>

                <div class="form-group">
                    <label class="form-label">Link Type</label>
                    <select id="linkType" class="form-control">
                        <option value="drive">Google Drive Link</option>
                        <option value="direct">Direct Direct URL</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Link URL</label>
                    <input type="url" id="pdfLink" class="form-control" placeholder="https://drive.google.com/..." required>
                </div>

                <div class="form-group">
                    <label class="form-label">Description (Optional)</label>
                    <textarea id="pdfDesc" class="form-control" rows="3" placeholder="Short details about the file..."></textarea>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;" id="uploadBtn">
                    <i class="fas fa-cloud-upload-alt"></i> Publish to Library
                </button>
            </form>
        </div>

        <div id="manage" class="admin-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Manage Documents</h3>
                <input type="text" id="adminSearch" placeholder="Search file by name..." onkeyup="filterAdminTable()" style="padding: 10px; border: 1px solid #ccc; border-radius: 4px; width: 250px;">
            </div>
            
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Downloads</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="adminPdfTableBody">
                        <tr>
                            <td colspan="4" style="text-align: center;">Loading data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="toast" class="toast">Action Successful!</div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // ==================== FIREBASE CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyBPAujSIQnIdXOhAGV1zwafvFiZr6z5u0Y",
            authDomain: "rds-library-3a1b0.firebaseapp.com",
            databaseURL: "https://rds-library-3a1b0-default-rtdb.firebaseio.com/",
            projectId: "rds-library-3a1b0",
            storageBucket: "rds-library-3a1b0.firebasestorage.app",
            messagingSenderId: "258223710686",
            appId: "1:258223710686:web:68872b10e298741b7dbd4f",
            measurementId: "G-1KTQSJGBP6"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Global Variables
        let allPdfs = [];
        let allCategories = [];

        // ==================== DATA LOADING ====================
        
        // Load Categories
        database.ref('categories').on('value', (snapshot) => {
            allCategories = [];
            const datalist = document.getElementById('categoryList');
            datalist.innerHTML = ''; // Clear existing
            
            if (snapshot.exists()) {
                snapshot.forEach((child) => {
                    const cat = { id: child.key, ...child.val() };
                    allCategories.push(cat);
                    
                    // Add to dropdown suggestion
                    const option = document.createElement('option');
                    option.value = cat.name;
                    datalist.appendChild(option);
                });
            }
            document.getElementById('adminTotalCats').textContent = allCategories.length;
        });

        // Load PDFs
        database.ref('pdfs').on('value', (snapshot) => {
            allPdfs = [];
            let totalDownloads = 0;
            
            if (snapshot.exists()) {
                snapshot.forEach((child) => {
                    const pdf = { id: child.key, ...child.val() };
                    allPdfs.push(pdf);
                    totalDownloads += (pdf.downloads || 0);
                });
            }
            
            // Update Stats
            document.getElementById('adminTotalPdfs').textContent = allPdfs.length;
            document.getElementById('adminTotalDownloads').textContent = totalDownloads;
            
            // Render Table
            renderAdminTable(allPdfs);
        });

        // ==================== FUNCTIONS ====================

        // Render Table
        function renderAdminTable(pdfsToRender) {
            const tbody = document.getElementById('adminPdfTableBody');
            tbody.innerHTML = '';

            if (pdfsToRender.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No documents found.</td></tr>';
                return;
            }

            // Sort by newest first
            const sortedPdfs = [...pdfsToRender].reverse();

            sortedPdfs.forEach(pdf => {
                // Find Category Name
                let catName = 'Uncategorized';
                if (pdf.categories && pdf.categories.length > 0) {
                    const catObj = allCategories.find(c => c.id === pdf.categories[0]);
                    if (catObj) catName = catObj.name;
                }

                const row = `
                    <tr>
                        <td><strong>${pdf.name}</strong><br><small style="color:#777">${pdf.description ? pdf.description.substring(0,30) : ''}...</small></td>
                        <td><span style="background:#e3f2fd; color:#1565c0; padding: 2px 8px; border-radius:10px; font-size:0.85em">${catName}</span></td>
                        <td>${pdf.downloads || 0}</td>
                        <td>
                            <button class="action-btn btn-delete" onclick="deletePdf('${pdf.id}', '${pdf.name}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // Upload Function
        document.getElementById('addPdfForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('uploadBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publishing...';
            btn.disabled = true;

            const title = document.getElementById('pdfTitle').value;
            const catNameInput = document.getElementById('pdfCategory').value.trim();
            const linkType = document.getElementById('linkType').value;
            const link = document.getElementById('pdfLink').value;
            const desc = document.getElementById('pdfDesc').value;

            try {
                // 1. Handle Category (Find existing or Create new)
                let catId = null;
                const existingCat = allCategories.find(c => c.name.toLowerCase() === catNameInput.toLowerCase());
                
                if (existingCat) {
                    catId = existingCat.id;
                } else {
                    // Create new category
                    const newCatRef = database.ref('categories').push();
                    await newCatRef.set({ name: catNameInput });
                    catId = newCatRef.key;
                }

                // 2. Prepare PDF Data
                const newPdf = {
                    name: title,
                    description: desc,
                    categories: [catId], // Storing as array to match viewer script
                    type: linkType, // 'drive' or 'direct'
                    uploadDate: new Date().toISOString(),
                    downloads: 0,
                    likes: 0,
                    comments: []
                };

                if (linkType === 'drive') {
                    newPdf.driveLink = link;
                } else {
                    newPdf.fileURL = link;
                }

                // 3. Push to Firebase
                await database.ref('pdfs').push(newPdf);

                // 4. Reset Form & Success
                document.getElementById('addPdfForm').reset();
                showToast('âœ… PDF Uploaded Successfully!');
                
            } catch (error) {
                console.error(error);
                alert("Error uploading: " + error.message);
            } finally {
                btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Publish to Library';
                btn.disabled = false;
            }
        });

        // Delete Function
        window.deletePdf = function(id, name) {
            if(confirm(`Are you sure you want to delete "${name}"?\nThis action cannot be undone.`)) {
                database.ref('pdfs/' + id).remove()
                .then(() => {
                    showToast('ðŸ—‘ï¸ Document Deleted');
                })
                .catch(err => {
                    alert('Error deleting: ' + err.message);
                });
            }
        };

        // Search/Filter Function
        window.filterAdminTable = function() {
            const input = document.getElementById('adminSearch');
            const filter = input.value.toLowerCase();
            const filtered = allPdfs.filter(pdf => pdf.name.toLowerCase().includes(filter));
            renderAdminTable(filtered);
        };

        // Utility: Show Toast
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        // Tab Switching Logic
        window.switchTab = function(tabId) {
            document.querySelectorAll('.admin-card').forEach(el => el.classList.remove('active-section'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active-section');
            const btns = document.querySelectorAll('.tab-btn');
            if(tabId === 'upload') btns[0].classList.add('active');
            if(tabId === 'manage') btns[1].classList.add('active');
        }
    </script>
</body>
</html>
